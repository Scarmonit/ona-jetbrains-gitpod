name: AI Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  detect-ai-mention:
    if: github.event.issue.pull_request || github.event.pull_request
    runs-on: ubuntu-latest
    outputs:
      copilot: ${{ steps.check.outputs.copilot }}
      gemini: ${{ steps.check.outputs.gemini }}
      claude: ${{ steps.check.outputs.claude }}
    steps:
      - name: Check for AI mentions
        id: check
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "copilot=$(echo "$COMMENT" | grep -qi '@copilot' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "gemini=$(echo "$COMMENT" | grep -qi '@gemini' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "claude=$(echo "$COMMENT" | grep -qi '@claude' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  copilot-review:
    needs: detect-ai-mention
    if: needs.detect-ai-mention.outputs.copilot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('files', files.map(f => f.filename).join('\n'));
            core.setOutput('title', pr.title);

      - name: Copilot Review Response
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸ¤– **GitHub Copilot Review Triggered**\n\nTo get a full Copilot review:\n1. Enable [GitHub Copilot code review](https://docs.github.com/en/copilot/using-github-copilot/code-review/using-copilot-code-review) in your repo settings\n2. Or use Copilot in your IDE to review the diff\n\n_This is an automated response to your @copilot mention._`
            });

  gemini-review:
    needs: detect-ai-mention
    if: needs.detect-ai-mention.outputs.gemini == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          gh pr diff $PR_NUMBER > diff.txt
          echo "diff_size=$(wc -c < diff.txt)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Gemini Review
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('diff.txt', 'utf8').slice(0, 30000);
            
            const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  parts: [{ text: `Review this code diff and provide constructive feedback on code quality, potential bugs, and improvements:\n\n${diff}` }]
                }]
              })
            });
            
            const data = await response.json();
            const review = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Unable to generate review';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ”· Gemini Code Review\n\n${review}\n\n---\n_Powered by Google Gemini_`
            });

      - name: Gemini Not Configured
        if: ${{ secrets.GEMINI_API_KEY == '' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸ”· **Gemini Review Requested**\n\nTo enable Gemini reviews, add \`GEMINI_API_KEY\` to your repository secrets.\n\nGet an API key at: https://aistudio.google.com/apikey`
            });

  claude-review:
    needs: detect-ai-mention
    if: needs.detect-ai-mention.outputs.claude == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          gh pr diff $PR_NUMBER > diff.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Review
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('diff.txt', 'utf8').slice(0, 50000);
            
            const response = await fetch('https://api.anthropic.com/v1/messages', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
              },
              body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [{
                  role: 'user',
                  content: `You are a senior code reviewer. Review this pull request diff and provide:\n1. Summary of changes\n2. Code quality assessment\n3. Potential bugs or issues\n4. Suggestions for improvement\n5. Security considerations\n\nBe constructive and specific. Format with markdown.\n\nDiff:\n${diff}`
                }]
              })
            });
            
            const data = await response.json();
            const review = data.content?.[0]?.text || 'Unable to generate review';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸŸ  Claude Code Review\n\n${review}\n\n---\n_Powered by Anthropic Claude_`
            });

      - name: Claude Not Configured
        if: ${{ secrets.ANTHROPIC_API_KEY == '' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸŸ  **Claude Review Requested**\n\nTo enable Claude reviews, add \`ANTHROPIC_API_KEY\` to your repository secrets.\n\nGet an API key at: https://console.anthropic.com/`
            });
