name: AI Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  detect-ai-mention:
    # Only run if this is a PR (issue_comment on a PR, or a review comment)
    if: github.event.issue.pull_request || github.event.pull_request
    runs-on: ubuntu-latest
    outputs:
      copilot: ${{ steps.check.outputs.copilot }}
      gemini: ${{ steps.check.outputs.gemini }}
      claude: ${{ steps.check.outputs.claude }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Determine PR number & check for AI mentions
        id: check
        run: |
          # Determine PR number for both event types safely
          PR_NUMBER="${{ github.event.issue.number }}"
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          COMMENT="${{ github.event.comment.body }}"
          # Fallback if body missing
          if [ -z "$COMMENT" ]; then COMMENT=""; fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "copilot=$(echo "$COMMENT" | grep -qi '@copilot' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "gemini=$(echo "$COMMENT" | grep -qi '@gemini' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "claude=$(echo "$COMMENT" | grep -qi '@claude' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  copilot-review:
    needs: detect-ai-mention
    if: needs.detect-ai-mention.outputs.copilot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Post Copilot trigger message
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = core.getInput('pr_number') || context.payload.issue?.number || context.payload.pull_request?.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸ¤– **GitHub Copilot Review Triggered**\n\nTo get a full Copilot review:\n1. Enable [GitHub Copilot code review](https://docs.github.com/en/copilot/using-github-copilot/code-review/using-copilot-code-review) in repository settings\n2. Or use Copilot in your IDE to review the diff\n\n_This is an automated response to your @copilot mention._`
            });

  prepare-diff:
    needs: detect-ai-mention
    if: needs.detect-ai-mention.outputs.gemini == 'true' || needs.detect-ai-mention.outputs.claude == 'true'
    runs-on: ubuntu-latest
    outputs:
      diff_path: diff.txt
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch PR diff
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER='${{ needs.detect-ai-mention.outputs.pr_number }}'
          if [ -z "$PR_NUMBER" ]; then echo "Missing PR number"; exit 1; fi
          # gh command exits non-zero if PR not found; trap to create helpful message
          set -e
          if ! gh pr diff "$PR_NUMBER" > diff.txt; then
            echo "Failed to get PR diff" >&2
            exit 1
          fi
          echo "Diff size: $(wc -c < diff.txt) bytes"

  gemini-review:
    needs: [detect-ai-mention, prepare-diff]
    if: needs.detect-ai-mention.outputs.gemini == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download diff artifact (implicit workspace)
        run: |
          echo "Using diff from previous job"
      - name: Gemini Review
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            let diff='';
            try { diff = fs.readFileSync('diff.txt','utf8').slice(0,30000); } catch(e){ diff='(Unable to read diff)'; }
            async function generate(){
              try {
                const resp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ contents:[{ parts:[{ text: `Review this code diff and provide constructive feedback on code quality, potential bugs, improvements, and security considerations.\n\nDiff:\n${diff}` }] }] })
                });
                const data = await resp.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No review text returned.';
              } catch(err){
                return 'Gemini API error: ' + err.message;
              }
            }
            const review = await generate();
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ”· Gemini Code Review\n\n${review}\n\n---\n_Powered by Google Gemini_`
            });
      - name: Gemini Not Configured
        if: ${{ secrets.GEMINI_API_KEY == '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸ”· **Gemini Review Requested**\n\nAdd repository secret \`GEMINI_API_KEY\` to enable automated Gemini reviews.\nGet a key: https://aistudio.google.com/apikey`
            });

  claude-review:
    needs: [detect-ai-mention, prepare-diff]
    if: needs.detect-ai-mention.outputs.claude == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Claude Review
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            let diff='';
            try { diff = fs.readFileSync('diff.txt','utf8').slice(0,50000); } catch(e){ diff='(Unable to read diff)'; }
            async function generate(){
              try {
                const resp = await fetch('https://api.anthropic.com/v1/messages', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': process.env.ANTHROPIC_API_KEY,
                    'anthropic-version': '2023-06-01'
                  },
                  body: JSON.stringify({
                    model: 'claude-3-5-sonnet-latest',
                    max_tokens: 2000,
                    messages: [{
                      role: 'user',
                      content: `You are a senior code reviewer. Provide:\n1. Summary of changes\n2. Code quality assessment\n3. Potential bugs or risky areas\n4. Improvement suggestions\n5. Security considerations\n\nBe concise and use markdown sections.\n\nDiff:\n${diff}`
                    }]
                  })
                });
                const data = await resp.json();
                const content = data.content?.[0]?.text || data.error?.message || 'No review text.';
                return content;
              } catch(err){ return 'Claude API error: ' + err.message; }
            }
            const review = await generate();
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸŸ  Claude Code Review\n\n${review}\n\n---\n_Powered by Anthropic Claude_`
            });
      - name: Claude Not Configured
        if: ${{ secrets.ANTHROPIC_API_KEY == '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸŸ  **Claude Review Requested**\n\nAdd repository secret \`ANTHROPIC_API_KEY\` to enable Claude reviews.\nGet a key: https://console.anthropic.com/`
            });